[gera-protocolo-sentinel]
; --- INICIO DA OPERACAO SENTINEL (WEB GUI EDITION) ---
; Autor: Ivann
; Versao: Production-NoSSH
;
; O sistema espera receber a URL como argumento do Custom Destination.
; Formato do Target: gera-protocolo-sentinel,s,1(URL_DO_WEBHOOK)

; 1. Validacao de Seguranca
exten => s,1,NoOp(>>> INICIANDO PROTOCOLO SENTINEL <<<)
same => n,Set(URL_WEBHOOK=${ARG1})
same => n,GotoIf($["${URL_WEBHOOK}" = ""]?erro_url)

; 2. Geracao do Protocolo (Timestamp Puro)
same => n,Set(__PROTOCOLO=${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)})

; 3. Coleta de Metadados
same => n,Set(D_ORIGEM=${CALLERID(num)})
same => n,Set(D_DESTINO=${CALLERID(dnid)})
same => n,Set(D_UNIQUEID=${UNIQUEID})
same => n,Set(D_CANAL=${CHANNEL})
same => n,Set(D_EPOCH=${EPOCH})

; 4. Auditoria Local (CDR)
; Grava o protocolo no campo 'Userfield' do relatorio de chamadas
same => n,Set(CDR(userfield)=${PROTOCOLO})

; 5. Disparo Externo (Webhook Assincrono)
; Utiliza o curl em background (&) para garantir zero latencia no audio
same => n,System(curl -s -H "Content-Type: application/json" -X POST -d '{"protocol":"${PROTOCOLO}", "caller_id":"${D_ORIGEM}", "did":"${D_DESTINO}", "unique_id":"${D_UNIQUEID}", "timestamp":"${D_EPOCH}", "channel":"${D_CANAL}"}' "${URL_WEBHOOK}" &)

; 6. Interacao com Cliente
same => n,Answer()
same => n,Wait(0.5)
; Certifique-se de ter criado a gravacao 'protocolo-intro' no System Recordings
same => n,Playback(custom/protocolo-intro)
same => n,SayDigits(${PROTOCOLO})
same => n,Wait(0.5)

; 7. Retorno para a GUI
same => n,Return()

; Bloco de Erro (Caso o Admin nao configure a URL)
same => n(erro_url),NoOp(!!! ERRO CRITICO: URL WEBHOOK AUSENTE NO CUSTOM DESTINATION !!!)
same => n,Return()
