[gera-protocolo-sentinel]
; --- INICIO DA OPERACAO SENTINEL (HYBRID MODE) ---
; Versao: 2.0 - Robustez Total
; O Webhook agora é opcional. O protocolo será gerado de qualquer forma.

; 1. MISSAO CRITICA: Gerar Protocolo e Gravar (Independente de Webhook)
exten => s,1,NoOp(>>> INICIANDO PROTOCOLO SENTINEL <<<)
same => n,Set(__PROTOCOLO=${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)})
same => n,Set(CDR(userfield)=${PROTOCOLO})

; 2. ANALISE DE RECURSO: O cliente quer Webhook?
; Captura o argumento vindo do Custom Destination
same => n,Set(URL_WEBHOOK=${ARG1})

; CONDICIONAL: Se a URL estiver vazia, PULA para o label 'falar_protocolo'
; Sintaxe: GotoIf(CONDICAO?LABEL_SE_VERDADEIRO:LABEL_SE_FALSO)
same => n,GotoIf($["${URL_WEBHOOK}" = ""]?falar_protocolo)

; 3. MISSAO AUXILIAR: Envio de Dados (So executa se nao pulou acima)
same => n,NoOp(--- URL detectada: Enviando Webhook ---)
same => n,Set(D_ORIGEM=${CALLERID(num)})
same => n,Set(D_DESTINO=${CALLERID(dnid)})
same => n,Set(D_UNIQUEID=${UNIQUEID})
same => n,Set(D_CANAL=${CHANNEL})
same => n,Set(D_EPOCH=${EPOCH})

; Disparo assincrono (&) para nao travar o audio caso a API esteja lenta
same => n,System(curl -s -H "Content-Type: application/json" -X POST -d '{"protocol":"${PROTOCOLO}", "caller_id":"${D_ORIGEM}", "did":"${D_DESTINO}", "unique_id":"${D_UNIQUEID}", "timestamp":"${D_EPOCH}", "channel":"${D_CANAL}"}' "${URL_WEBHOOK}" &)

; 4. INTERACAO COM O CLIENTE (Ponto de encontro do salto)
same => n(falar_protocolo),NoOp(--- Iniciando Audio do Protocolo ---)
same => n,Answer()
same => n,Wait(0.5)

; Audio de introducao (Ex: "Anote seu protocolo")
same => n,Playback(custom/protocolo-intro)

; Fala os digitos
same => n,SayDigits(${PROTOCOLO})
same => n,Wait(0.5)

; 5. CONCLUSAO
same => n,Return()
